<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=1">
	<title>Demo of 'Convert Youtube Embeds to Image Links'</title>
	<style type="text/css">
		html, html body {
			font-family: sans-serif; }
		body {
			padding: 10px; margin: 0; }
		h1 {
			margin-bottom: 36px; }
		h1, h1 a {
			font-size: 36px;
			color: red;
			text-decoration: none; }
		iframe, object, .video-container {
			margin: 0 10px 10px 0;
			display: inline-block;
			float: left; }
		.video-container {
			background-color: gray;
			padding: 0;
			line-height: 3;
			text-indent: 10px;
			font-size: 18px; }
		footer {
			clear: both; }
		pre {
			text-align: left;
			background-color: #DDD;
			color: #111;
			font-family: monospace;
			padding: 10px;
			white-space: pre;
			overflow: auto; }
		.html_source {
			color: #DEDEDE;
			background-color: #333; }
	</style>
</head>
<body>
<section>
	<h1><a href="https://github.com/elundmark/Convert-Youtube-Embeds-to-Image-Links-UserScript/">Demo of &quot;Convert Youtube Embeds to Image Links&quot;</a></h1>
	<iframe width="320" height="180" src="//www.youtube.com/embed/fKX_eEtrrHI" frameborder="0" allowfullscreen></iframe>
	<!-- Dynamically injected embed -->
	<div class="video-container" data-video-id="PZinsSmIGWE" style="width:320px;height:180px;">Loading video...</div>
	<div class="video-container" data-video-id="hqKafI7Amd8" style="width:320px;height:180px;">Loading video...</div>
	<script type="text/javascript">
		"use strict";
		setTimeout(function () {
			Array.prototype.slice.call(document.querySelectorAll(".video-container"), 0).forEach(function (node) {
				var videoIframe = document.createElement("IFRAME");
				videoIframe.setAttribute("src", "//www.youtube.com/embed/"+node.dataset.videoId);
				videoIframe.setAttribute("width", "320");
				videoIframe.setAttribute("height", "180");
				videoIframe.setAttribute("frameborder", "0");
				videoIframe.setAttribute("allowfullscreen", "allowfullscreen");
				node.parentNode.replaceChild(videoIframe, node);
			});
		}, 1000);
	</script>
	<!-- Old-school embed -->
	<object width="320" height="180">
		<param name="movie" value="https://www.youtube.com/v/UOUYPnpJsK0"></param>
		<param name="allowFullScreen" value="true"></param>
		<param name="allowscriptaccess" value="always"></param>
		<embed src="https://www.youtube.com/v/UOUYPnpJsK0" type="application/x-shockwave-flash" width="320" height="180" allowscriptaccess="always" allowfullscreen="true"></embed>
	</object>
</section>
<aside>
	These four videos are loaded in the following order: <b>1.</b> Normal <code>&lt;iframe&gt;</code>, <b>2 - 3.</b> Dynamically injected after a delay, <b>4.</b> An oldschool <code>&lt;object&gt;</code>.
</aside>
<footer>
	<pre class="html_source">&lt;!-- HTML Source --&gt;

<code id="hc"></code>
	</pre>
	<pre>/* UserScript Source
In this demo all videos open in the same window, but the actual userscript will open the them in a new tab */

<code id="sc"></code>
	</pre>
</footer>
<script type="text/javascript" id="us">//<![CDATA[ 
var GM_openInTab = function (u) { top.window.location.href = u; };
window.	sectionHtml = document.querySelector("section").innerHTML.replace(/^\t/gm, "");
window.addEventListener("load", function () {
//{BEGIN CODE}

// ==UserScript==
// @name         Convert Youtube Embeds to Image Links
// @description  Tries to turn embedded Youtube videos into thumbnails - this is based on "Stop Overzealous Embedding" https://openuserjs.org/users/ConnorBehan
// @namespace	 http://elundmark.se/code/
// @version      0.1.6
// @date         2015-02-08
// @autor        Erik Lundmark
// @contact      mail@elundmark.se
// @license      MIT; http://opensource.org/licenses/MIT
// @supportURL   https://github.com/elundmark/Convert-Youtube-Embeds-to-Image-Links-UserScript/issues
// @updateURL    http://elundmark.se/_files/js/convert_youtube_embeds_to_image_links/convert_youtube_embeds_to_image_links.meta.js
// @downloadURL  http://elundmark.se/_files/js/convert_youtube_embeds_to_image_links/convert_youtube_embeds_to_image_links.user.js
// @icon         data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAAA1VBMVEUAAAAAAAAFAQEGAQEHAQEIAQENAgIPAwMVBAQaBQUdBQUeBgYhBwcfCgosCQkyCgo3Cws8DAxADQ1GDg49FBRSEBBdExNhFBRwFxd5GBhAKCh6GRk4MjKMHR2PHR1DPT2nIyOtJCREQ0O2JiatKSm5JibBKCjIKirNKyvPKyvQKyvZLS3aLS3eLS3fLS3gLS3dLi7eLi7fLi7gLi7eLy/fLy/gLy/eNTXhNja0VFTkSkrkS0u5dHTpbW3pbm7vl5fwl5fks7PEv7/2wcH74+P++Pj///+XlX/1AAAAAXRSTlMAQObYZgAABERJREFUeAHtm2mT20QYhF8BCUeAbDh2uckSYGGJNLFm1IT7nv//kyirFrrsidc91UWRD34+pVIVPf0e8uFR4sR/y4kTJ4Zh+H/9W+z0jn/FSu/6V6z0hp9Y6Q0/sdIbfmKlN/zE+Nd330dGBsY55zmPUwKmksqIsWBl/WMqCSjTmOdNmr95fTAS5LdeHHZ4cI0+ntwfWt6dsEEcARnA+bDPvUv08Ojt4RncubjClryJQ4wAcEU/eXBp+5kAWIIQrFxdDESYgtB/co4byuaQHxd3BtJMwfMzAVBijxkr5/T39oB+KcEcO0wA52/0gPM/tgdY5PlzEy1/kyDvB7ji/PUpqH7y3mPcQH9q90+cQr//3tdoW4AtH9Kv90DdP/qvQXY38ImU/1KsX9gj3gn9V7DqJ4kBOhJcK/ULfs4g8yr39SnY/edrwaj3kT3w+88AIPom+vXzHcG4llE/l2B2q3HuHq4A5E3k9Xw/pohYmo3SExj9ZwtKu9NyTUb9fC207mqzfhQGIPoeePWvMIC6B3XglT92/QygJ6iVEe56/W8DKJtYKyPY9TOAvomVCZz6GWBGX4J6g18/A3QlqP9i+MkSE4hyN1Zi9n9l5ivxsU1kAGLWv3YgAWoPGIB49QOZOyD2oO5h1Q+U6P22VRscPxAZRJkCxcTwcwfUKVRCev1kYgCxB/XZ9PrZARCpB/UQXX4SY+fvTvUgHX5SooAoU6i3IPtJChBpCvVW6O/cAb0H9XY++/EpeigBlccvM8Bt/PmzEUDYw3qcP37wAxD65QD1r1+f+gFavx6Ac/AD8DNyX4Cf/ACtXw7w+y/+CNr+6wGGdy79JWz9agD+iuMHoF8OIPyman4iEvxdPYgi7R+R9HoPUoySn2h6+V2xhNZ/ovrVBJEEvxCg+5sBA0h+Iuu1PZgiSfMnul+7FyJL9RNNr/cgZslPJL3egxJJ8hPdL21ijkWffxvgI+eUZ2WJRfKTnXfdb/vPF5oAs9r/JsBv35snXeyA7meAT78zzplIRHT4GWD44HPjtKoJIM6fAYY3rt2TLgaQ/ITfv7yTriaA2tHadNTaRAboqcY6NWsCFPtKRoIlIjZ6/f7JKeGhlXH+Z5y1gcfXi1GFsT0cgV9/91kbiS1u/UYHGcCo30jAw2vDb21i+ifAl0b/rT2IFeCrl4z6jSnwMb6HZz257QRfYGXiYzy4esWvX96Ds0d7D7SBCVy/ss9nDzkBBuAUhP47m0g/9h9mOzPr5x5I/hJkYQ+s+oUErH8OIUHjdzeR/hQ7gAn6/fom0o/YozCB7ecmCvWTwgSEfn8K9I9LEILUJKDf7gH9JcdBZhQmoN/uAf0lzXGMV20/N5G8+cmUOh/vf4F/s8wZmNbn+zcTFpQ8oqQFqZQyAiWVhKVMI0rO8wjktGwLfc37Dwbh0+knpp/Q34nlJ34zfVy/D/3PJSdOnDhx4m//OuSgMioX6QAAAABJRU5ErkJggg==
// @include      *
// @exclude      http*://*.youtube.com/*
// @exclude      http*://youtube.com/*
// @exclude      http*://*.youtube-nocookie.com/*
// @exclude      http*://youtube-nocookie.com/*
// @exclude      http*://*.youtu.be/*
// @exclude      http*://youtu.be/*
// @exclude      http*://*.ytimg.com/*
// @grant        GM_openInTab
// ==/UserScript==

/*
	Example webpage(s)
	--------------------------------------------------------------------------------------------------------
	http://elundmark.se/_files/js/convert_youtube_embeds_to_image_links/cye2il-demo/
	http://terrillthompson.com/tests/youtube.html
	http://www.rottentomatoes.com/m/tv_editorial/news/1931451/11_tv_shows_cancelled_after_the_first_episode/
	--------------------------------------------------------------------------------------------------------
*/

// Un-comment this line if you want to open the videos in the same window
//var tabLink = function (u) { location.href = u; };

(function () {
	"use strict";
	var video_link,
		iframeHtml,
		openLink = typeof tabLink === "undefined" ? GM_openInTab : tabLink,
		ytWatchBaseHref = "https://www.youtube.com/watch?v=",
		risky_tags = ["object", "embed", "iframe"],
		MutationObserver,
		observer,
		getIframeTmpl = function (th) {
			return [
				"<!DOCTYPE html>\n"+
				"<head>\n"+
				"<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\" />\n"+
				"<title>Youtube Embed</title>\n"+
				"<style> * { margin: 0 !important; padding: 0 !important; }\n"+
				"html, html body { overflow: hidden !important; }\n"+
				"a[href*='youtube.com/watch'] > span:hover { background-color: rgba(0, 0, 0, 0.3) !important; }\n</style>"+
				"</head>\n"+
				"<body>\n",
				th,
				"</body>\n"+
				"</html>"
			];
		},
		// Source: https://www.iconfinder.com/icons/317714/video_youtube_icon
		youtubeIcon = "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAMAAAD04JH5AAACZ1BMVEUAAAD/A"+
			"AD/VVX/Pz/MMzPUKiraJCTfHx/iODjlMzPnLi7pKirXJyfaNjbdMzPfLy/iKiraMDDdLCzfKirhMTHjLS3bKyvdMzPeMT"+
			"HfLy/gLi7hLS3iMTHjMDDgMDDiLS3eMDDfLi7gLS3hLS3hMTHdLy/eLi7fMTHgMDDgLy/hLi7eLS3fLy/gLi7hMDDhMDD"+
			"eLi7fLi7fLS3fMDDgLi7hLi7hLS3fLy/fLi7gLS3hMDDhLy/fLi7fLS3fMDDgLy/gLy/eMDDfLy/fLy/gLS3fLi7fMDDg"+
			"Li7hLS3fLy/fLy/fLi7fLi7gLi7gLy/fLi7fLS3gLy/gLi7gLi7fLy/fLy/fLi7gLy/gLy/gLy/fLi7fLi7gLy/gLy/gL"+
			"i7gLi7fLy/fLy/fLy/fLi7eLi7gLy/gLy/gLS3fLi7fLi7gLy/gLi7gLi7gLi7fLy/fLy/fLS3eLi7gLi7gLy/fLS3fLi"+
			"7eLy/gLy/gLi7gLi7fLy/fLy/fLy/eLS3gLi7gLy/gLy/gLy/gLS3fLi7fLi7eLy/eLy/gLS3gLS3gLi7gLy/fLy/eLS3"+
			"eLi7gLi7gLy/gLy/gLS3fLS3fLi7eLy/gLy/gLS3gLi7gLy/fLy/fLy/eLS3gLi7gLy/gLy/fLS3fLi7eLy/eLy/eLy/g"+
			"LS3gLS3gLi7gLy/fLy/eLS3gLy/gLy/gLy/gLS3fLS3eLi7eLy/eLy/gLS3gLS3gLS3gLy/fLy/eLy/eLS3eLS3gLy/gL"+
			"y/gLS3eLS3eLS3eLy/eLy/gLy/hNjbkSkrkS0vpbW3pbm7vl5fwl5f2wcH74+P++Pj///8YYQu/AAAAwXRSTlMAAgMEBQ"+
			"YHCAkKCwwNDg8QEhUXGBocHR4fICEiJCUqLS8xMjM0Njc5Ojs8PkFCREVHSElKTE1OUFJUVVZYWVpbXF9gYWRpam1vcHF"+
			"yc3R2eXp8fX+BgoOFhoeIioyNjo+QkZKTlJaXmJmanZ6foKGio6SlpqmqrK2vsLGys7S1tre4ubq7vL2+v8DBwsTFxsfI"+
			"ycrLzM7P0NHS09XW19ja29zd3t/g4eLj5efo6err7O3u7/Dx8vP09fb3+fr7/P3+bYe0egAAA45JREFUeNrt2ntXFWUYB"+
			"fBtmYhaEphmaGqkGeal1MzMFMsKMypDLTNNUVS8QGERGWpRBpVmHsIjRge7gKLgQYmT4PHMlrBMPpQcvLzL63LO8zrPP/"+
			"P7BHvtPbPmnVkDn8/n8/l8vltKThv52ISpz2fNX7jo3ZX5G4tLysor9wT2Hwz90dDY3NIaOdURddjLiXacirSGmxobfg8"+
			"d3B/YXVH+xacfb1y7YunbC+dnzXxmwpgRqf1xp4ZPX7Ci+KvAoeNRWnW6uW7fzo+WZ08bhtsYl1/Pu65+zVjcXOYP9Mj3"+
			"T+BGSfn0jrMmCdcZEqSnqtJwjaF19FjdEMBICdFzNYNglFDBJlw1lSoycUU1VVTisolUkoFLtlLJevQa1E4lJ/oibhbVT"+
			"EHcZqpZhbgjVFODHunU46QAmE3qXgTvU9GbAMqoqAhADRV9B6CFiuqAftQUAYbSnfP/0KaBeJzudF/47yztScfTbgN0d/"+
			"9/jtaMw1y3AeLs7TAd2YkEsLfDPCxJJIC9HRYgL5EA9nZYjKJEAtjbIQ/bEglgb4dCVEgCyHcoRUASQL7DLtRKAsh32It"+
			"6SQD5DgfQJAkg3yGEVkkA+Q6H0S4JIN/hKM5IAsh3CMORBJDvcBKUBJDv0CYLIN8hYi+A2UEtgNlBLYDZQSuA2UE7QJfu"+
			"BP/qTnC+U/c27FK6DU37KgFM++78Zfdh1JXAwyhKd6y0b4QFBxJB+8ZRwZFM0L7RIDiUCto3QviT7lhp3wjiF7pjpX3jR"+
			"8GrmWlf4Bvxy2knRT7D53THSvvGFhTSHSvtG6sln2g6KZeLXLpjpX0jG6/RHdO+FVl4ke6Y9q2Yhil0x7RvxVhk0B3Tvh"+
			"WP4CG6Y9q3Ihn3OVTUBuA4FYUABKmoAsA2KtoC4D0qygEwi4omAXiYemIPoEcD1VQjroBqPkDcc1QzEXHJf1NJ873oVUQ"+
			"lebgkk0pG4bK9VPElrniKGpwMXFWocwUYAw/Qcz8lAUZaLT0WTME1UnbRU98OxnX6vBGhZ6KL78GNUpefoCec0kdxc/1m"+
			"bKh1eHfFqpeMxO0MGDMzp2BH4LdwzPK/7VVfb123KOvJ+3HHklNHjB4/+dkXXnrl9bdyl61cW1D0Sen28srd+36u+fVQ/"+
			"ZFj4ZNt7adjTiza0R5pbWlqPNzzc3+wak9leVlJ8eZ1Hy57J+fVl+fMmDx+dPqD/eHz+Xw+n893SxcBv2lqOtWj2hcAAA"+
			"AASUVORK5CYII=",
		realCss = function (el, s) {
			return window.getComputedStyle(el, null).getPropertyValue(s);
		},
		makeImageAnchor = function (e, isIframe) {
			var url = ytWatchBaseHref+e.url,
				link = document.createElement("a"),
				span = document.createElement("span"),
				linkCss = "",
				spanCss = "";
			e.dims.map(function (item) {
				if (/^\d+$/.test(item+"")) return item+"px";
				return item;
			});
			e.elMargins.map(function (item) {
				if (/^\d+$/.test(item+"")) return item+"px";
				return item;
			});
			link.href = url;
			link.title = url;
			link.target = "_top";
			linkCss = "position:relative !important; background:url('https://i3.ytimg.com/vi/"+e.url+"/0.jpg')"+
				" no-repeat scroll 50% 50% / 133% auto transparent !important; "+
				"width:"+e.dims[0]+" !important; "+
				"height:"+e.dims[1]+" !important; ";
			if (isIframe) {
				linkCss += "display:block !important; ";
			} else {
				linkCss += "display:"+(/^(inline|none)$/.test(e.elDisplay) ? "inline-block" : e.elDisplay)+" !important; "+
					"margin-top:"+e.elMargins[0]+" !important; "+
					"margin-bottom:"+e.elMargins[1]+" !important; "+
					(e.elMargins[2] !== "0px" ? "margin-left:"+e.elMargins[2]+" !important; " : "")+
					(e.elMargins[3] !== "0px" ? "margin-right:"+e.elMargins[3]+" !important; " : "")+
					"float:"+(e.elFloat||"none")+" !important;";
			}
			link.style.cssText = linkCss;
			spanCss = "position: absolute !important; "+
				"top: 0 !important; bottom: 0 !important; "+
				"left: 0 !important; right: 0 !important; "+
				"background-color:rgba(0, 0, 0, 0.08); "+ // leave w/o important rule to enable :hover support
				"background-image:url('"+youtubeIcon+"') !important; "+
				"background-position:50% 50% !important; "+
				"background-repeat:no-repeat !important; "+
				"background-size:64px 64px !important; ";
			span.style.cssText = spanCss;
			span.innerHTML = "&nbsp;";
			link.appendChild(span);
			return link;
		},
		init = function (dynamicNode) {
			var index,
				risky_node,
				risky_attributes,
				bad_elements = [],
				risky = !dynamicNode ? document.querySelectorAll(risky_tags.join(", ")) : [dynamicNode];
			for (var j = 0, jLen = risky.length; j < jLen; j+=1) {
				index = 0;
				risky_attributes = risky[j].attributes;
				for (var k = 0, kLen = risky_attributes.length; k < kLen; k+=1) {
					risky_node = risky_attributes[k].value;
					if ((risky_node.indexOf("youtube.com") >= 0) || (risky_node.indexOf("ytimg.com") >= 0) || (risky_node.indexOf("youtube-nocookie.com") >= 0)) {
						if (risky_node.indexOf("/v/") >= 0) {
							index = risky_node.indexOf("/v/")+3;
						} else if (risky_node.indexOf("?v=") >= 0) {
							index = risky_node.indexOf("?v=")+3;
						} else if (risky_node.indexOf("/embed/") >= 0) {
							index = risky_node.indexOf("/embed/")+7;
						}
						if (index > 0) {
							bad_elements.push({
								el: risky[j],
								elMargins: [
									realCss(risky[j], "margin-top"),
									realCss(risky[j], "margin-bottom"),
									realCss(risky[j], "margin-left"),
									realCss(risky[j], "margin-right")
								],
								elFloat: realCss(risky[j], "float"),
								elDisplay: realCss(risky[j], "display"),
								url: risky_node.substring(index, index+11),
								dims: [
									realCss(risky[j], "width") || risky[j].width || risky[j].clientWidth || "auto",
									realCss(risky[j], "height") || risky[j].height || risky[j].clientHeight || "auto"
								]
							});
						}
						break;
					}
				}
			}
			bad_elements.forEach(function (o) {
				var linkTabHandler = function (event) {
					event.preventDefault();
					var el = event.currentTarget;
					if (el.nodeName === "A") {
						el = el.querySelector("span");
					}
					// alias for GM_openInTab
					openLink(ytWatchBaseHref+o.url);
					el.style.setProperty("background-color", "rgba(0, 0, 0, 0.6)", "important");
					return false;
				};
				if (o.el.nodeName === "IFRAME") {
					video_link = makeImageAnchor(o, true);
					// Stop the iframe anchor link, and set a click event w/ GM_openInTab on the iframe later
					iframeHtml = getIframeTmpl(video_link.outerHTML).join("");
					// Remove any safeguards so I can access the iframe later
					o.el.removeAttribute("sandbox");
					o.el.addEventListener("load", function () {
						if (o.el.contentDocument) {
							o.el.contentDocument.querySelectorAll("a")[0].onclick = linkTabHandler;
						} else if (o.el.contentWindow) {
							(o.el.contentWindow.document||o.el.document).querySelectorAll("a")[0].onclick = linkTabHandler;
						}
					});
					o.el.src = "data:text/html,base64,"+window.btoa(iframeHtml);
					// To prevent browser caching (ie ff) I'm settings both src & srcdoc
					o.el.srcdoc = iframeHtml;
				} else {
					video_link = makeImageAnchor(o);
					// Stop the default anchor link and set a click event w/ GM_openInTab
					video_link.onclick = linkTabHandler;
					o.el.style.display = "none";
					o.el.parentNode.replaceChild(video_link, o.el);
				}
			});
		};
	// http://michalbe.blogspot.com/2013/04/javascript-less-known-parts-dom.html
	// https://developer.mozilla.org/en/docs/Web/API/MutationObserver
	MutationObserver = window.MutationObserver || window.WebKitMutationObserver || window.MozMutationObserver;
	observer = new MutationObserver(function(mutations) {
		mutations.forEach(function(mutation) {
			if (mutation.addedNodes && mutation.addedNodes.length) {
				Array.prototype.slice.call(mutation.addedNodes, 0).forEach(function (node) {
					if (node.nodeName && risky_tags.indexOf(node.nodeName.toLowerCase()) !== -1) {
						init(node);
					}
				});
			}
		});
	});
	init();
	observer.observe(document.body, {
		childList: true,
		subtree: true,
		attributes: false,
		characterData: false
	});
}());

//{END CODE}
});
//]]>
</script>
<script type="text/javascript">
	window.addEventListener("load", function () {
		"use strict";
		document.querySelector("#sc").textContent = (
			document.querySelector("#us").textContent.match(/\/\/\{BEGIN CODE\}([\s\S]+)\/\/\{END CODE\}/i)[1]
		)+"";
		document.querySelector("#hc").textContent = window.sectionHtml;
	});
</script>
</body>
</html>
